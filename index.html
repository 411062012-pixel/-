<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>道教疏文自動生成系統</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- Google Fonts: Noto Serif TC for traditional look -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 自定義樣式 */
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #57534e; /* 深色背景讓紙張更明顯 */
        }

        /* 隱藏滾動條但保留功能 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 3px;
        }

        /* A4 紙張模擬 - 橫式預覽模式 */
        .a4-page {
            width: 297mm;  /* 橫向寬度 */
            height: 210mm; /* 橫向高度 */
            background: white;
            margin: 0 auto;
            padding: 15mm;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            /* 預覽時使用 Flexbox 讓直書從右邊開始 */
            display: flex;
            flex-direction: row-reverse; 
            align-items: flex-start;
        }

        /* 疏文直書樣式核心 */
        .shuwen-text {
            writing-mode: vertical-rl; /* 垂直書寫，從右到左 */
            text-orientation: upright; /* 文字直立 */
            height: 100%;             
            width: 100%;              
            white-space: pre-wrap;    /* 保留手動換行 */
            word-break: break-all;    /* 強制斷行 */
            overflow-wrap: anywhere;  /* 防止溢出 */
        }

        /* === 嚴格的列印控制 (CSS Print Reset) === */
        @media print {
            /* 1. 設定紙張大小與無邊界 */
            @page {
                size: A4 landscape; /* 強制 A4 橫向 */
                margin: 0mm !important; /* 關鍵：移除瀏覽器預設頁邊距 */
            }

            /* 2. 重置 HTML/Body 尺寸 */
            html, body {
                width: 297mm;
                height: 210mm;
                margin: 0 !important;
                padding: 0 !important;
                background: white;
                overflow: visible !important;
            }

            /* 3. 隱藏所有非列印元素 */
            body > *:not(#root) {
                display: none !important;
            }
            .no-print {
                display: none !important;
            }

            /* 4. 列印區域設定 */
            .print-area {
                display: block !important; /* 移除 Flex，使用 Block 避免分頁錯誤 */
                position: absolute;
                top: 0;
                left: 0;
                width: 297mm;
                margin: 0;
                padding: 0;
            }
            
            .print-area * {
                visibility: visible;
            }

            /* 5. A4 頁面強制設定 */
            .a4-page {
                position: relative !important;
                width: 297mm !important;
                height: 210mm !important;
                margin: 0 !important;
                padding: 15mm !important; /* 保持內距 */
                
                /* 強制分頁 */
                page-break-after: always !important; 
                break-after: page !important;
                
                /* 移除螢幕顯示用的樣式 */
                box-shadow: none !important;
                border: none !important;
                background: white !important;
                
                /* 預覽時用 Flex，列印時改回 Block，讓瀏覽器處理內容流動，避免 Flex 跨頁 bug */
                display: block !important; 
                float: none !important;
                left: 0 !important;
                top: 0 !important;

                /* 確保背景圖形/顏色被列印 */
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* 修正最後一頁多出空白頁的問題 */
            .a4-page:last-child {
                page-break-after: auto !important;
                break-after: auto !important;
            }

            /* 確保文字在列印時依然是直書 */
            .shuwen-text {
                width: 100% !important;
                height: 100% !important;
                display: block;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const DEFAULT_TEMPLATE = `伏以
至誠拜請
三界高真    十方聖賢    
    
今據
{{地址}}
居住
    
奉道信士
{{信士}}    本命 {{出生年月}} 生
公司行號
{{公司}}
    
誠心叩求
天官賜福    地官赦罪    水官解厄
    
祈求
生意興隆    財源廣進    闔家平安    萬事如意
    
    
天運    歲次    {{農曆年}}    年    {{農曆月}}    月    {{農曆日}}    日
    
具疏上申`;

        function App() {
            const [mode, setMode] = useState('single'); 
            const [template, setTemplate] = useState(DEFAULT_TEMPLATE);
            
            // 排版參數
            const [fontSize, setFontSize] = useState(24);
            const [lineHeight, setLineHeight] = useState(2.0);
            const [letterSpacing, setLetterSpacing] = useState(0.1);
            
            // 資料
            const [singleData, setSingleData] = useState({
                信士: '',
                出生年月: '',
                公司: '',
                地址: '',
                農曆年: '甲辰',
                農曆月: '一',
                農曆日: '一'
            });

            const [bulkData, setBulkData] = useState([]);
            
            const handleSingleChange = (e) => {
                const { name, value } = e.target;
                setSingleData(prev => ({ ...prev, [name]: value }));
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        setBulkData(results.data);
                        alert(`成功匯入 ${results.data.length} 筆資料！`);
                    },
                    error: (err) => {
                        alert("CSV 解析失敗：" + err.message);
                    }
                });
            };

            const downloadSampleCSV = () => {
                const csvContent = "\uFEFF信士,出生年月,公司,地址,農曆年,農曆月,農曆日\n王大明,甲子年一月一日吉時,大明發發有限公司,台北市信義區信義路一段一號,甲辰,五,初一\n林小美,乙丑年二月二日吉時,,新北市板橋區文化路一段二號,甲辰,五,初一";
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "疏文匯入範本.csv");
                document.body.appendChild(link);
                link.click();
            };

            const generateText = (data) => {
                let text = template;
                const keys = text.match(/{{(.*?)}}/g);
                if (keys) {
                    keys.forEach(key => {
                        const fieldName = key.replace('{{', '').replace('}}', '');
                        text = text.replace(key, data[fieldName] || '      ');
                    });
                }
                return text;
            };

            // 核心功能：透過列印機制匯出 PDF
            const handleExportPDF = () => {
                try {
                    window.focus();

                    const originalTitle = document.title;
                    
                    if (mode === 'single') {
                        const name = singleData.信士 || '未命名';
                        document.title = `疏文_${name}`;
                    } else if (mode === 'bulk') {
                        const count = bulkData.length;
                        document.title = `疏文_批量匯出_共${count}筆`;
                    }

                    // 提示使用者
                    alert("【重要提示】\n\n1. 請在列印視窗中，將「邊界」設定為「無」或「最小值」。\n2. 勾選「背景圖形」以確保完整顯示。\n3. 目的地選擇「另存為 PDF」。");

                    setTimeout(() => {
                        window.print();
                        setTimeout(() => {
                            document.title = originalTitle;
                        }, 500);
                    }, 100);
                } catch (err) {
                    console.error("Print error:", err);
                    alert("無法自動開啟列印視窗。請手動按下鍵盤的 'Ctrl + P' (Mac 請按 Cmd + P)。");
                }
            };

            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    {/* 左側控制面板 */}
                    <div className="w-full md:w-1/3 bg-white border-r border-gray-200 p-6 overflow-y-auto no-print h-screen sticky top-0 flex flex-col shadow-xl z-10 custom-scrollbar">
                        <div className="flex-none">
                            <h1 className="text-2xl font-bold text-stone-800 mb-6 flex items-center border-b pb-4">
                                <span className="text-4xl mr-3 text-red-700">☯</span> 
                                <div>
                                    <div>道教疏文系統</div>
                                    <div className="text-xs text-gray-400 font-normal mt-1">A4 橫式・直書排版・批量生成</div>
                                </div>
                            </h1>

                            <div className="flex mb-6 bg-gray-100 p-1 rounded-lg">
                                {['single', 'bulk', 'template'].map(m => (
                                    <button 
                                        key={m}
                                        onClick={() => setMode(m)} 
                                        className={`flex-1 py-2 rounded-md text-sm font-bold transition-all ${mode === m ? 'bg-white text-red-600 shadow' : 'text-gray-500 hover:text-gray-700'}`}
                                    >
                                        {m === 'single' ? '單張輸入' : m === 'bulk' ? '批量匯入' : '排版設定'}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="flex-grow overflow-y-auto pr-2 custom-scrollbar">
                            {mode === 'single' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-red-50 border border-red-100 p-3 rounded-lg">
                                        <div className="text-xs font-bold text-red-800 mb-1">主要資訊</div>
                                        <div className="space-y-3">
                                            <input type="text" name="信士" value={singleData.信士} onChange={handleSingleChange} className="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition" placeholder="信士姓名 (例: 王大明)" />
                                            <input type="text" name="出生年月" value={singleData.出生年月} onChange={handleSingleChange} className="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-red-500" placeholder="出生年月 (例: 甲子年...)" />
                                            <input type="text" name="公司" value={singleData.公司} onChange={handleSingleChange} className="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-red-500" placeholder="公司行號 (選填)" />
                                        </div>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-gray-700 mb-1 block">詳細地址</label>
                                        <textarea name="地址" value={singleData.地址} onChange={handleSingleChange} rows="3" className="block w-full border border-gray-300 rounded-md p-2 focus:ring-2 focus:ring-red-500" placeholder="居住地址..."></textarea>
                                    </div>

                                    <div className="grid grid-cols-3 gap-2 bg-gray-50 p-3 rounded-lg border">
                                        <div><label className="text-xs text-gray-500 block text-center mb-1">歲次</label><input type="text" name="農曆年" value={singleData.農曆年} onChange={handleSingleChange} className="w-full text-center border rounded p-1" /></div>
                                        <div><label className="text-xs text-gray-500 block text-center mb-1">月份</label><input type="text" name="農曆月" value={singleData.農曆月} onChange={handleSingleChange} className="w-full text-center border rounded p-1" /></div>
                                        <div><label className="text-xs text-gray-500 block text-center mb-1">日期</label><input type="text" name="農曆日" value={singleData.農曆日} onChange={handleSingleChange} className="w-full text-center border rounded p-1" /></div>
                                    </div>

                                    {/* 快速排版工具 */}
                                    <div className="pt-4 border-t border-gray-200">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="text-xs font-bold text-gray-500">字體大小調整</span>
                                            <span className="text-xs bg-gray-200 px-2 rounded">{fontSize}pt</span>
                                        </div>
                                        <input type="range" min="14" max="40" value={fontSize} onChange={(e) => setFontSize(parseInt(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-600" />
                                    </div>
                                </div>
                            )}

                            {mode === 'bulk' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 text-sm text-blue-800">
                                        <h3 className="font-bold mb-2 flex items-center"><svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> 使用說明</h3>
                                        <ol className="list-decimal pl-4 space-y-1 text-blue-700">
                                            <li>下載 CSV 範本檔案。</li>
                                            <li>使用 Excel 編輯並儲存。</li>
                                            <li>上傳檔案，系統自動生成頁面。</li>
                                            <li>點擊匯出，選擇「另存為 PDF」。</li>
                                        </ol>
                                    </div>
                                    
                                    <div className="grid grid-cols-2 gap-2">
                                        <button onClick={downloadSampleCSV} className="border border-gray-300 p-2 rounded hover:bg-gray-50 text-sm flex items-center justify-center text-gray-600">
                                            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> 下載範本
                                        </button>
                                        <label className="border border-red-200 bg-red-50 p-2 rounded cursor-pointer hover:bg-red-100 text-sm flex items-center justify-center text-red-700 font-bold transition">
                                            <input type="file" accept=".csv" onChange={handleFileUpload} className="hidden" />
                                            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg> 上傳資料
                                        </label>
                                    </div>

                                    {bulkData.length > 0 && (
                                        <div className="text-center py-2 bg-green-100 text-green-800 rounded text-sm font-bold">
                                            已載入 {bulkData.length} 筆資料
                                        </div>
                                    )}

                                    <div className="pt-4 border-t">
                                         <label className="text-xs font-bold text-gray-500 block mb-2">批量排版統一設定</label>
                                         <input type="range" min="14" max="40" value={fontSize} onChange={(e) => setFontSize(parseInt(e.target.value))} className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-red-600" />
                                    </div>
                                </div>
                            )}

                            {mode === 'template' && (
                                <div className="space-y-4 animate-fade-in">
                                    <div className="bg-yellow-50 p-3 rounded text-sm text-yellow-800 border border-yellow-200">
                                        <p>請保留 <code>{`{{變數}}`}</code> 格式。</p>
                                    </div>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="flex justify-between text-xs font-bold text-gray-600 mb-1">
                                                <span>行距 (Line Height)</span><span>{lineHeight}</span>
                                            </label>
                                            <input type="range" min="1.0" max="3.5" step="0.1" value={lineHeight} onChange={(e) => setLineHeight(parseFloat(e.target.value))} className="w-full accent-gray-600" />
                                        </div>
                                        <div>
                                            <label className="flex justify-between text-xs font-bold text-gray-600 mb-1">
                                                <span>字距 (Spacing)</span><span>{letterSpacing}</span>
                                            </label>
                                            <input type="range" min="0" max="1" step="0.05" value={letterSpacing} onChange={(e) => setLetterSpacing(parseFloat(e.target.value))} className="w-full accent-gray-600" />
                                        </div>
                                        <textarea value={template} onChange={(e) => setTemplate(e.target.value)} rows="15" className="w-full border rounded p-2 text-sm font-mono focus:ring-2 focus:ring-yellow-500 outline-none"></textarea>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="mt-4 pt-4 border-t bg-white">
                            <button 
                                onClick={handleExportPDF}
                                disabled={mode === 'bulk' && bulkData.length === 0}
                                className={`w-full py-4 px-6 rounded-lg shadow-lg flex items-center justify-center transform active:scale-95 transition-all
                                    ${mode === 'bulk' && bulkData.length === 0 
                                        ? 'bg-gray-200 text-gray-400 cursor-not-allowed' 
                                        : 'bg-gradient-to-r from-red-600 to-red-700 text-white hover:from-red-500 hover:to-red-600'}`}
                            >
                                <svg className="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <div className="text-left">
                                    <div className="text-lg font-bold">匯出 PDF / 列印</div>
                                    <div className="text-xs opacity-80 font-normal">請在視窗中選擇「另存為 PDF」</div>
                                </div>
                            </button>
                            
                            <div className="mt-3 text-center">
                                <p className="text-xs text-gray-400 mb-2">
                                    快速鍵：<kbd className="font-sans bg-gray-100 px-1 rounded border">Ctrl</kbd> + <kbd className="font-sans bg-gray-100 px-1 rounded border">P</kbd>
                                </p>
                            </div>
                        </div>
                    </div>

                    {/* 右側預覽區 */}
                    <div className="flex-1 bg-stone-600 overflow-auto flex flex-col items-center p-8 print-area custom-scrollbar">
                        {/* 樣式動態注入 */}
                        <style>{`
                            .dynamic-style {
                                font-size: ${fontSize}pt;
                                line-height: ${lineHeight};
                                letter-spacing: ${letterSpacing}em;
                            }
                        `}</style>

                        {(mode === 'single' || mode === 'template') && (
                            <div className="a4-page transition-transform duration-200 ease-in-out">
                                <div className="shuwen-text dynamic-style">
                                    {generateText(singleData)}
                                </div>
                            </div>
                        )}

                        {mode === 'bulk' && bulkData.length > 0 && bulkData.map((data, index) => (
                            <div key={index} className="a4-page mb-10 print:mb-0">
                                <div className="shuwen-text dynamic-style">
                                    {generateText(data)}
                                </div>
                                <div className="absolute bottom-2 left-2 text-xs text-gray-300 no-print">{index + 1}</div>
                            </div>
                        ))}
                        
                        {mode === 'bulk' && bulkData.length === 0 && (
                            <div className="flex flex-col items-center justify-center h-full text-gray-300 opacity-50">
                                <svg className="w-24 h-24 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="1" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <p className="text-xl">等待資料匯入...</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>